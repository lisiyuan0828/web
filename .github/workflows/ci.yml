# .github/workflows/frontend.yml
name: Deploy Frontend

on:
  push:
    branches: [ "main", "develop" ]

env:
  IMAGE_REPO: ccr.ccs.tencentyun.com/4web/frontend

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: ${{ github.ref == 'refs/heads/main' && 'production' || 'staging' }}

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set environment
      run: |
        if [ "$GITHUB_REF" = "refs/heads/main" ]; then
          echo "NAMESPACE=prod" >> $GITHUB_ENV
          echo "BUILD_ENV=production" >> $GITHUB_ENV  # ← 构建环境变量
        else
          echo "NAMESPACE=staging" >> $GITHUB_ENV
          echo "BUILD_ENV=staging" >> $GITHUB_ENV     # ← 构建环境变量
        fi
        echo "IMAGE_TAG=${GITHUB_REF#refs/heads/}-${GITHUB_SHA::8}" >> $GITHUB_ENV

    - name: Login to TCR
      run: |
        echo "${{ secrets.TCR_PASSWORD }}" | docker login ccr.ccs.tencentyun.com -u "${{ secrets.TCR_USERNAME }}" --password-stdin

    - name: Build and Push Image
      run: |
        # 传递 BUILD_ENV 参数给 Docker 构建
        docker build \
          --build-arg ENVIRONMENT=${{ env.BUILD_ENV }} \
          -t ${{ env.IMAGE_REPO }}:${{ env.IMAGE_TAG }} \
          .
        docker push ${{ env.IMAGE_REPO }}:${{ env.IMAGE_TAG }}