# .github/workflows/frontend.yml
name: Deploy Frontend

on:
  push:
    branches: [ "main", "develop" ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: ${{ github.ref == 'refs/heads/main' && 'production' || 'staging' }}

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set environment and image repo
      run: |
        if [ "$GITHUB_REF" = "refs/heads/main" ]; then
          echo "NAMESPACE=prod" >> $GITHUB_ENV
          echo "IMAGE_REPO=ccr.ccs.tencentyun.com/4web/frontend" >> $GITHUB_ENV
        else
          echo "NAMESPACE=staging" >> $GITHUB_ENV
          echo "IMAGE_REPO=ccr.ccs.tencentyun.com/4web/frontend-develop" >> $GITHUB_ENV
        fi
        echo "IMAGE_TAG=${GITHUB_REF#refs/heads/}-${GITHUB_SHA::8}" >> $GITHUB_ENV

    - name: Login to TCR
      run: |
        echo "${{ secrets.TCR_PASSWORD }}" | docker login ccr.ccs.tencentyun.com -u "${{ secrets.TCR_USERNAME }}" --password-stdin

    - name: Build and Push Image
      run: |
        docker build -t ${{ env.IMAGE_REPO }}:${{ env.IMAGE_TAG }} .
        docker push ${{ env.IMAGE_REPO }}:${{ env.IMAGE_TAG }}

    - name: Configure kubectl
      run: |
        curl -LO https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl
        chmod +x kubectl && sudo mv kubectl /usr/local/bin/
        pip3 install tencentcloud-cli
        tencentcloud tke DescribeClusterKubeconfig --ClusterId "${{ secrets.TKE_CLUSTER_ID }}" --Output kubectl > ~/.kube/config

    - name: Update Deployment
      run: |
        # 注意：Deployment 名称在 prod 和 staging 命名空间中都是 "frontend"
        kubectl set image deployment/frontend frontend=${{ env.IMAGE_REPO }}:${{ env.IMAGE_TAG }} -n ${{ env.NAMESPACE }}
        kubectl rollout status deployment/frontend -n ${{ env.NAMESPACE }}